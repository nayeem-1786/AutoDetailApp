# Project Conventions — Smart Details Auto Spa

This document defines the shared patterns, component APIs, and conventions used across all modules. Module-specific docs (COUPONS.md, etc.) reference this file for the "how to build" foundation.

---

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Framework | Next.js 16 (App Router, Turbopack) |
| Language | TypeScript (strict) |
| Database | PostgreSQL via Supabase |
| Auth | Supabase Auth (email/password, phone OTP, magic link for POS PIN) |
| Styling | Tailwind CSS (mobile-first) |
| Forms | react-hook-form + Zod validation |
| Tables | @tanstack/react-table |
| Toasts | sonner |
| Icons | lucide-react |
| Payments | Stripe (Terminal for POS, Payment Intents for online) |

---

## Directory Structure

```
src/
├── app/
│   ├── admin/                    # Admin panel (requires employee auth)
│   │   ├── page.tsx             # /admin dashboard
│   │   ├── customers/
│   │   │   ├── page.tsx         # List page
│   │   │   ├── new/page.tsx     # Create page
│   │   │   └── [id]/page.tsx    # Detail page
│   │   └── marketing/
│   │       ├── coupons/
│   │       │   ├── page.tsx
│   │       │   ├── new/page.tsx
│   │       │   └── [id]/page.tsx
│   │       └── campaigns/
│   │           ├── page.tsx
│   │           └── _components/ # Page-specific components (prefixed with _)
│   ├── api/                     # API route handlers
│   │   ├── marketing/
│   │   │   └── coupons/
│   │   │       ├── route.ts     # GET (list), POST (create)
│   │   │       └── [id]/
│   │   │           ├── route.ts # GET (detail), PATCH (update), DELETE
│   │   │           └── stats/route.ts
│   │   └── pos/
│   │       └── coupons/validate/route.ts
│   ├── pos/                     # POS system (PIN auth)
│   │   ├── page.tsx
│   │   ├── components/          # POS-specific components
│   │   └── context/             # POS state management (React Context + useReducer)
│   └── (auth)/                  # Auth pages (login, signup)
├── components/
│   └── ui/                      # Shared UI component library
├── lib/
│   ├── supabase/
│   │   ├── client.ts            # Browser client (anon key, singleton)
│   │   ├── server.ts            # Server client (anon key, cookie-based sessions)
│   │   ├── admin.ts             # Admin client (service role key, bypasses RLS)
│   │   ├── types.ts             # Hand-written TypeScript types matching DB schema
│   │   └── database.types.ts    # Auto-generated by Supabase CLI (do not edit)
│   ├── auth/
│   │   ├── auth-provider.tsx    # AuthProvider context (session, employee, role, permissions)
│   │   ├── roles.ts             # Route access by role (ROUTE_ACCESS map)
│   │   └── permissions.ts       # Permission checking helpers
│   ├── hooks/
│   │   ├── use-feature-flag.ts  # Feature flag hook with 60s client-side cache
│   │   └── use-permission.ts    # Permission hooks (usePermission, useIsSuperAdmin, etc.)
│   └── utils/
│       ├── cn.ts                # Tailwind class merger (clsx + twMerge)
│       ├── constants.ts         # Business constants, label maps, feature flag keys
│       ├── format.ts            # formatCurrency, formatDate, formatPhone, etc.
│       ├── form.ts              # formResolver wrapper (Zod + react-hook-form)
│       ├── validation.ts        # Zod schemas + shared field validators
│       ├── audience.ts          # Campaign audience filter helpers
│       ├── email.ts             # Email sending (Mailgun)
│       ├── sms.ts               # SMS sending (Twilio)
│       ├── template.ts          # Message template variable replacement
│       ├── quote-number.ts      # Quote number generation
│       └── webhook.ts           # Webhook dispatching
└── supabase/
    └── migrations/              # Postgres migrations (never delete, append only)
```

**File naming rules:**
- Pages: `page.tsx` (always `'use client'` for admin/POS pages)
- API routes: `route.ts` (server-only, never `'use client'`)
- Components: kebab-case (`customer-lookup.tsx`)
- Utils: kebab-case (`validation.ts`)
- Dynamic segments: `[id]/`, `[slug]/` (lowercase)
- Page-specific components: `_components/` directory (prefixed with `_`)

---

## Supabase Clients

Three clients for different contexts:

### Browser Client (`src/lib/supabase/client.ts`)
```typescript
import { createClient } from '@/lib/supabase/client';
const supabase = createClient(); // Singleton, uses anon key, respects RLS
```
**Use in:** Client components (`'use client'`), customer-facing pages.

### Server Client (`src/lib/supabase/server.ts`)
```typescript
import { createClient } from '@/lib/supabase/server';
const supabase = await createClient(); // Async, reads cookies for session
```
**Use in:** API routes (most common), server components. Respects RLS — queries scoped to authenticated user's permissions.

### Admin Client (`src/lib/supabase/admin.ts`)
```typescript
import { createAdminClient } from '@/lib/supabase/admin';
const admin = createAdminClient(); // Service role key, bypasses RLS
```
**Use in:** API routes that need unrestricted access (PIN login, customer account linking, admin operations on behalf of users). Never use in client code.

---

## Authentication Patterns

### Admin API Routes

Every admin API route follows this two-step pattern:

```typescript
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  const supabase = await createClient();

  // Step 1: Verify authenticated user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Step 2: Verify employee role
  const { data: employee } = await supabase
    .from('employees')
    .select('role')
    .eq('auth_user_id', user.id)
    .single();

  if (!employee || !['super_admin', 'admin'].includes(employee.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // ... route logic
}
```

Role checks vary by route:
- Admin routes: `['super_admin', 'admin']`
- POS routes: `['super_admin', 'admin', 'cashier']`
- Staff management: `['super_admin']`

### POS PIN Authentication

POS uses PIN-based auth with rate limiting:
1. Employee enters 4-digit PIN at `/pos/login`
2. API validates PIN against `employees` table, checks `status: 'active'`
3. Rate limiting: 5 failures in 5 minutes = 15-minute lockout (tracked by IP)
4. On success: generates Supabase magic link token, client verifies via OTP
5. Session established, employee data loaded into POS context

### Customer Authentication

- Primary: Phone OTP (Supabase Auth + Twilio)
- Secondary: Email/password
- Account linking: matches customers by phone → email → creates new
- No employee record required — customer portal uses `CustomerAuthProvider`

### Client-Side Auth Context

```typescript
import { useAuth } from '@/lib/auth/auth-provider';

const { session, user, employee, role, permissions, loading, signOut } = useAuth();
```

Provides: session state, employee record, role, permission overrides, loading state.

### Permission Hooks

```typescript
import { usePermission, useIsSuperAdmin, useIsAdminOrAbove } from '@/lib/hooks/use-permission';

const canManageCoupons = usePermission('manage_coupons');
const isSuperAdmin = useIsSuperAdmin();
const isAdmin = useIsAdminOrAbove();
```

### Feature Flag Hooks

```typescript
import { useFeatureFlag } from '@/lib/hooks/use-feature-flag';

const { enabled: loyaltyEnabled, loading } = useFeatureFlag('loyalty_rewards');
```

Client-side cache with 60s TTL. Flags stored in `feature_flags` table.

---

## API Response Shapes

### Success — Single Item
```typescript
return NextResponse.json({ data: item });           // 200
return NextResponse.json({ data: item }, { status: 201 }); // 201 Created
```

### Success — List
```typescript
return NextResponse.json({ data: items });
// Or with pagination:
return NextResponse.json({ data: items, total: count, page, limit });
```

### Error
```typescript
return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
return NextResponse.json({ error: 'Not found' }, { status: 404 });
return NextResponse.json({ error: 'Coupon code already exists' }, { status: 409 });
```

### Validation Error
```typescript
return NextResponse.json(
  { error: 'Validation failed', details: parsed.error.flatten().fieldErrors },
  { status: 400 }
);
```

### HTTP Status Codes Used
| Code | Meaning | When |
|------|---------|------|
| 200 | OK | GET success, PATCH success |
| 201 | Created | POST success |
| 400 | Bad Request | Validation failure |
| 401 | Unauthorized | No auth session |
| 403 | Forbidden | Wrong role |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate (e.g., coupon code) |
| 429 | Too Many Requests | Rate limited (POS PIN) |
| 500 | Internal Server Error | Unhandled exception |

---

## API Route Structure (CRUD Pattern)

### Collection Route (`route.ts` — GET list, POST create)

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest) {
  const supabase = await createClient();
  // Auth check...

  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get('page') || '1');
  const limit = parseInt(searchParams.get('limit') || '20');
  const offset = (page - 1) * limit;

  const { data, count } = await supabase
    .from('table')
    .select('*', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1);

  return NextResponse.json({ data, total: count, page, limit });
}

export async function POST(request: NextRequest) {
  const supabase = await createClient();
  // Auth check...

  const body = await request.json();
  const parsed = schema.safeParse(body);
  if (!parsed.success) {
    return NextResponse.json(
      { error: 'Validation failed', details: parsed.error.flatten().fieldErrors },
      { status: 400 }
    );
  }

  const { data, error } = await supabase
    .from('table')
    .insert(parsed.data)
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data }, { status: 201 });
}
```

### Item Route (`[id]/route.ts` — GET detail, PATCH update, DELETE)

```typescript
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const supabase = await createClient();
  // Auth check...

  const body = await request.json();

  // Allowlist pattern for PATCH updates
  const allowedFields = ['name', 'status', 'code', /* ... */];
  const updates: Record<string, unknown> = {};
  for (const key of allowedFields) {
    if (key in body) updates[key] = body[key];
  }

  const { error } = await supabase.from('table').update(updates).eq('id', id);

  // Fetch updated record to return
  const { data } = await supabase.from('table').select('*').eq('id', id).single();
  return NextResponse.json({ data });
}
```

---

## Zod Validation

### Shared Field Validators (`src/lib/utils/validation.ts`)

```typescript
import { z } from 'zod';

// Reusable validators
export const requiredString = z.string().min(1, 'Required');
export const optionalString = z.string().optional().nullable();
export const positiveNumber = z.coerce.number().min(0, 'Must be 0 or greater');
export const positiveInt = z.coerce.number().int().min(0, 'Must be 0 or greater');
export const phoneSchema = z.string()
  .regex(/^(\(\d{3}\) \d{3}-\d{4}|\+1\d{10})$/, 'Enter a valid 10-digit phone number')
  .or(z.literal('')).optional().nullable();
export const emailSchema = z.string().email('Invalid email address')
  .or(z.literal('')).optional().nullable();
```

### Schema Pattern

```typescript
// Create schema — all required fields
export const customerCreateSchema = z.object({
  first_name: requiredString,
  last_name: requiredString,
  phone: phoneSchema,
  email: emailSchema,
  tags: z.array(z.string()).default([]),
  sms_consent: z.boolean().default(false),
});

// Update schema — all fields optional
export const customerUpdateSchema = customerCreateSchema.partial();

// Type inference
export type CustomerCreateInput = z.infer<typeof customerCreateSchema>;
export type CustomerUpdateInput = z.infer<typeof customerUpdateSchema>;
```

### Usage in API Routes

```typescript
const parsed = couponSchema.safeParse(body);
if (!parsed.success) {
  return NextResponse.json(
    { error: 'Validation failed', details: parsed.error.flatten().fieldErrors },
    { status: 400 }
  );
}
const data = parsed.data; // Fully typed
```

### Usage in Forms (react-hook-form)

```typescript
import { useForm } from 'react-hook-form';
import { formResolver } from '@/lib/utils/form';

const form = useForm<CustomerUpdateInput>({
  resolver: formResolver(customerUpdateSchema),
});
```

The `formResolver` wrapper (`src/lib/utils/form.ts`) bridges Zod v4 + react-hook-form type compatibility.

---

## UI Component Library

All components live in `src/components/ui/`. Import from `@/components/ui/<name>`.

### Badge

```typescript
import { Badge } from '@/components/ui/badge';

<Badge variant="success">Active</Badge>
<Badge variant="warning">Expired</Badge>
<Badge variant="destructive">Disabled</Badge>
<Badge variant="info">20% off</Badge>
<Badge variant="default">Draft</Badge>
<Badge variant="secondary">Unknown</Badge>
```

| Variant | Colors | Common Use |
|---------|--------|-----------|
| `default` | Gray bg, dark text | Draft, neutral states |
| `secondary` | Gray bg, lighter text | Fallback |
| `success` | Green bg | Active, completed |
| `warning` | Yellow bg | Expired, attention |
| `destructive` | Red bg | Disabled, errors, cancelled |
| `info` | Blue bg | Discounts, info badges |

### Button

```typescript
import { Button } from '@/components/ui/button';

<Button>Default</Button>
<Button variant="destructive">Delete</Button>
<Button variant="outline">Cancel</Button>
<Button variant="secondary">Secondary</Button>
<Button variant="ghost">Ghost</Button>
<Button variant="link">Link</Button>
<Button size="sm">Small</Button>
<Button size="lg">Large</Button>
<Button size="icon"><Plus className="h-4 w-4" /></Button>
```

### Card

```typescript
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from '@/components/ui/card';

<Card>
  <CardHeader>
    <CardTitle>Title</CardTitle>
    <CardDescription>Optional description</CardDescription>
  </CardHeader>
  <CardContent>
    {/* Content */}
  </CardContent>
  <CardFooter>
    {/* Actions */}
  </CardFooter>
</Card>
```

### DataTable

```typescript
import { DataTable } from '@/components/ui/data-table';
import type { ColumnDef } from '@tanstack/react-table';

const columns: ColumnDef<Item, unknown>[] = [
  {
    accessorKey: 'name',
    header: 'Name',
    size: 200,               // Column width in px
    cell: ({ row }) => <span>{row.original.name}</span>,
    enableSorting: false,    // Disable sorting for this column
  },
  {
    id: 'custom',            // Use `id` instead of `accessorKey` for computed columns
    header: () => <div className="text-center w-full">Centered Header</div>,
    size: 130,
    cell: ({ row }) => <div className="text-center">content</div>,
  },
];

<DataTable
  columns={columns}
  data={items}
  pageSize={20}
  emptyTitle="No items found"
  emptyDescription="Create your first item."
  emptyAction={<Button>Create</Button>}
  exportFilename="items-export"
/>
```

Features: sorting (click headers), pagination, CSV export, bulk actions, column widths.

### Dialog

```typescript
import { Dialog, DialogHeader, DialogTitle, DialogDescription, DialogContent, DialogFooter } from '@/components/ui/dialog';

<Dialog open={open} onOpenChange={setOpen}>
  <DialogHeader>
    <DialogTitle>Dialog Title</DialogTitle>
    <DialogDescription>Optional description</DialogDescription>
  </DialogHeader>
  <DialogContent>
    {/* Form fields */}
  </DialogContent>
  <DialogFooter>
    <Button variant="outline" onClick={() => setOpen(false)}>Cancel</Button>
    <Button onClick={handleSubmit}>Save</Button>
  </DialogFooter>
</Dialog>
```

### ConfirmDialog

```typescript
import { ConfirmDialog } from '@/components/ui/confirm-dialog';

<ConfirmDialog
  open={deleteOpen}
  onOpenChange={setDeleteOpen}
  title="Delete Item"
  description="This action cannot be undone."
  confirmLabel="Delete"
  variant="destructive"
  loading={deleting}
  onConfirm={handleDelete}
/>
```

### FormField

```typescript
import { FormField } from '@/components/ui/form-field';

<FormField
  label="Coupon Name"
  htmlFor="name"
  required
  description="Human-readable label for this coupon"
  error={errors.name?.message}
>
  <Input id="name" value={name} onChange={(e) => setName(e.target.value)} />
</FormField>
```

### SearchInput

```typescript
import { SearchInput } from '@/components/ui/search-input';

<SearchInput
  value={search}
  onChange={setSearch}
  placeholder="Search by name or code..."
  className="w-full sm:w-64"
/>
```

### PageHeader

```typescript
import { PageHeader } from '@/components/ui/page-header';

<PageHeader
  title="Coupons"
  description="24 coupons total"
  action={<Button><Plus className="h-4 w-4" /> Create</Button>}
/>
```

### Other Components

| Component | Import | Usage |
|-----------|--------|-------|
| `Input` | `@/components/ui/input` | Text/number/date inputs |
| `Select` | `@/components/ui/select` | Dropdown `<select>` with `<option>` children |
| `Textarea` | `@/components/ui/textarea` | Multi-line text |
| `Checkbox` | `@/components/ui/checkbox` | Checkbox input |
| `Switch` | `@/components/ui/switch` | Toggle switch |
| `Label` | `@/components/ui/label` | Form labels |
| `Spinner` | `@/components/ui/spinner` | Loading indicator (`size: 'sm' | 'md' | 'lg'`) |
| `Skeleton` | `@/components/ui/skeleton` | Loading placeholder |
| `EmptyState` | `@/components/ui/empty-state` | Empty list state with icon, title, description, action |
| `Pagination` | `@/components/ui/pagination` | Page navigation with ellipsis |
| `Tabs` | `@/components/ui/tabs` | `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent` |
| `Table` | `@/components/ui/table` | Raw table primitives (used by DataTable) |
| `DropdownMenu` | `@/components/ui/dropdown-menu` | Context menus |

---

## Utility: `cn()` — Class Name Merging

```typescript
import { cn } from '@/lib/utils/cn';

// Merges Tailwind classes, handles conflicts
<div className={cn(
  'flex items-center gap-2',
  isActive && 'bg-green-50',
  className
)} />
```

Uses `clsx` + `tailwind-merge`. Always use `cn()` instead of string concatenation for Tailwind classes.

---

## Format Utilities (`src/lib/utils/format.ts`)

```typescript
import { formatCurrency, formatDate, formatDateTime, formatPhone, formatPoints } from '@/lib/utils/format';

formatCurrency(50.25)              // "$50.25"
formatDate('2024-02-03')           // "Feb 3, 2024"
formatDateTime('2024-02-03T14:30') // "Feb 3, 2024, 2:30 PM"
formatTime('14:30')                // "2:30 PM"
formatPhone('+13105551234')        // "(310) 555-1234"
normalizePhone('310-555-1234')     // "+13105551234" (E.164)
formatPhoneInput('310555')         // "(310) 555" (progressive)
formatPoints(1500)                 // "1,500"
```

---

## Constants (`src/lib/utils/constants.ts`)

### Business Settings
```typescript
export const TAX_RATE = 0.1025;          // 10.25% CA sales tax
export const TAX_PRODUCTS_ONLY = true;   // Tax products, not services
export const WATER_SKU = '0000001';      // Excluded from loyalty
export const CC_FEE_RATE = 0.05;         // 5% CC fee deducted from card tips
export const TIP_PRESETS = [15, 20, 25] as const;
```

### Config Objects
```typescript
export const LOYALTY = { EARN_RATE: 1, REDEEM_RATE: 0.05, REDEEM_MINIMUM: 100 } as const;
export const APPOINTMENT = { BUFFER_MINUTES: 30, CANCELLATION_WINDOW_HOURS: 24 } as const;
export const BUSINESS = { NAME: '...', ADDRESS: '...', PHONE: '...' } as const;
```

### Label Maps (enum → display text)

Pattern: `Record<string, string>` with `as const`.

```typescript
export const ROLE_LABELS: Record<string, string> = {
  super_admin: 'Super Admin',
  admin: 'Admin',
  cashier: 'Cashier',
  detailer: 'Detailer',
} as const;

export const COUPON_STATUS_LABELS: Record<string, string> = {
  draft: 'Draft',
  active: 'Active',
  disabled: 'Disabled',
} as const;

// Also: VEHICLE_SIZE_LABELS, VEHICLE_TYPE_LABELS, PRICING_MODEL_LABELS,
// APPOINTMENT_STATUS_LABELS, TRANSACTION_STATUS_LABELS, PO_STATUS_LABELS,
// QUOTE_STATUS_LABELS, DISCOUNT_TYPE_LABELS, APPLIES_TO_LABELS,
// CAMPAIGN_STATUS_LABELS, CAMPAIGN_CHANNEL_LABELS, CONSENT_ACTION_LABELS
```

### Feature Flag Keys
```typescript
export const FEATURE_FLAGS = {
  LOYALTY_REWARDS: 'loyalty_rewards',
  SMS_MARKETING: 'sms_marketing',
  EMAIL_MARKETING: 'email_marketing',
  // ...
} as const;
```

---

## TypeScript Types (`src/lib/supabase/types.ts`)

Hand-written types matching the Postgres schema. This is the source of truth for TypeScript — not the auto-generated `database.types.ts`.

### Pattern

```typescript
// Enums as union types
export type CouponStatus = 'draft' | 'active' | 'disabled';
export type UserRole = 'super_admin' | 'admin' | 'cashier' | 'detailer';

// Row types
export interface Coupon {
  id: string;
  name: string | null;
  code: string;
  status: CouponStatus;
  // ... all columns
  created_at: string;
  updated_at: string;
  // Joined relations (optional, populated by select queries)
  rewards?: CouponReward[];
}

// Generic action result
export type ActionResult<T> =
  | { success: true; data: T }
  | { success: false; error: string };
```

**Rules:**
- Every table gets an interface
- `id`, `created_at`, `updated_at` on every type
- Foreign keys are `string | null`
- Joined relations are optional (`rewards?: CouponReward[]`)
- Arrays use `string[]` (Postgres arrays)
- JSON columns use `Record<string, unknown>`
- Timestamps are `string` (ISO 8601 from Supabase)

---

## Page Patterns

### List Page

```typescript
'use client';

export default function ItemsListPage() {
  const router = useRouter();
  const supabase = createClient();

  const [items, setItems] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('');

  useEffect(() => {
    async function load() {
      setLoading(true);
      const { data } = await supabase
        .from('items')
        .select('*')
        .order('created_at', { ascending: false });
      if (data) setItems(data);
      setLoading(false);
    }
    load();
  }, []);

  const filtered = useMemo(() => {
    return items.filter((item) => {
      if (search && !item.name.toLowerCase().includes(search.toLowerCase())) return false;
      if (statusFilter && item.status !== statusFilter) return false;
      return true;
    });
  }, [items, search, statusFilter]);

  if (loading) return <div className="flex items-center justify-center py-12"><Spinner size="lg" /></div>;

  return (
    <div className="space-y-6">
      <PageHeader title="Items" description={`${items.length} total`}
        action={<Button onClick={() => router.push('/admin/items/new')}><Plus className="h-4 w-4" /> Create</Button>} />
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center">
        <SearchInput value={search} onChange={setSearch} placeholder="Search..." className="w-full sm:w-64" />
        <Select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="w-full sm:w-40">
          <option value="">All Statuses</option>
          {/* options */}
        </Select>
      </div>
      <DataTable columns={columns} data={filtered}
        emptyTitle="No items found" emptyDescription="Create your first item." />
    </div>
  );
}
```

### Detail Page

```typescript
'use client';

export default function ItemDetailPage() {
  const params = useParams();
  const id = params.id as string;

  const [item, setItem] = useState<Item | null>(null);
  const [loading, setLoading] = useState(true);

  // Inline edit states
  const [editingField, setEditingField] = useState(false);
  const [editValue, setEditValue] = useState('');
  const [inlineSaving, setInlineSaving] = useState(false);

  // Dialog states
  const [confirmOpen, setConfirmOpen] = useState(false);

  useEffect(() => { /* load item */ }, [id]);

  if (loading) return <Spinner />;
  if (!item) return <p>Not found.</p>;

  return (
    <div className="space-y-6">
      <PageHeader title={item.name} action={/* buttons */} />
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {/* Info cards with inline editing */}
      </div>
      {/* Detail cards */}
    </div>
  );
}
```

### Inline Edit Pattern

```typescript
// State
const [editingCode, setEditingCode] = useState(false);
const [editCode, setEditCode] = useState('');
const [inlineSaving, setInlineSaving] = useState(false);

// Save function
async function saveCode() {
  const trimmed = editCode.trim().toUpperCase();
  if (!trimmed) { toast.error('Cannot be empty'); return; }
  setInlineSaving(true);
  try {
    const res = await fetch(`/api/items/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code: trimmed }),
    });
    if (res.ok) {
      const { data } = await res.json();
      setItem(data);
      setEditingCode(false);
      toast.success('Updated');
    } else {
      const { error } = await res.json();
      toast.error(error || 'Update failed');
    }
  } catch {
    toast.error('Update failed');
  } finally {
    setInlineSaving(false);
  }
}
```

### Toggle Pattern (for list page status/boolean toggles)

```typescript
const [togglingId, setTogglingId] = useState<string | null>(null);

async function toggleStatus(item: Item) {
  setTogglingId(item.id);
  try {
    const res = await fetch(`/api/items/${item.id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: item.status === 'active' ? 'disabled' : 'active' }),
    });
    if (res.ok) {
      const { data } = await res.json();
      setItems((prev) => prev.map((i) => (i.id === data.id ? { ...i, ...data } : i)));
      toast.success('Status updated');
    } else {
      const { error } = await res.json();
      toast.error(error || 'Failed to update');
    }
  } catch {
    toast.error('Failed to update');
  } finally {
    setTogglingId(null);
  }
}
```

---

## Toast Notifications

```typescript
import { toast } from 'sonner';

toast.success('Coupon created');
toast.error('Failed to save');
toast.error(result.error || 'Something went wrong');  // API error with fallback
```

**Rules:**
- Success toast after every successful mutation
- Error toast on every failed API call with fallback message
- Use API error message when available: `result.error || 'Fallback'`
- No loading toasts — use button disabled states and spinners instead

---

## Database Conventions

### Migrations

- Location: `supabase/migrations/`
- Naming: `YYYYMMDD######_description.sql` (e.g., `20260201000020_create_coupons.sql`)
- Never delete existing migrations — append only
- Enum changes: prefer adding values over removing (removing requires `DROP TYPE`)

### Common Column Patterns

Every table has:
- `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- `created_at TIMESTAMPTZ DEFAULT now()`
- `updated_at TIMESTAMPTZ DEFAULT now()`

Foreign keys: `_id` suffix (e.g., `customer_id`, `coupon_id`)
Boolean flags: `is_` prefix (e.g., `is_active`, `is_single_use`)
Counts: descriptive name (e.g., `use_count`, `visit_count`)
Nullable arrays: `TEXT[]` or `UUID[]` (null means "not set", empty array means "none selected")

---

## Responsive Design

Mobile-first Tailwind patterns:
```html
<!-- Full width on mobile, fixed width on desktop -->
<div className="w-full sm:w-64" />

<!-- Stack on mobile, row on desktop -->
<div className="flex flex-col gap-4 sm:flex-row sm:items-center" />

<!-- Grid: 1 col → 2 col → 4 col -->
<div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4" />
```

---

## Module Documentation Pattern

Each module has a dedicated `.md` file in `docs/` that covers:

1. **Overview** — What the module does, key design principles
2. **Data Model** — Tables, columns, relationships
3. **User Flows** — Step-by-step UI flows (wizard steps, form flows)
4. **Dependencies** — Which conventions, components, and tables are required
5. **Scenario Reference** — Example configurations and use cases
6. **Integration Points** — Files that reference this module
7. **Implementation Status** — Phase-by-phase changelog

Module docs reference this CONVENTIONS.md for shared patterns and component APIs rather than duplicating them.
